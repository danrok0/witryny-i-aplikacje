"""
SKRYPT KOMPLEKSOWEJ AKTUALIZACJI DANYCH SYSTEMU
==============================================

Ten skrypt s≈Çu≈ºy do pobierania i aktualizacji wszystkich danych zewnƒôtrznych
u≈ºywanych przez system rekomendacji tras turystycznych.

NOWE W ETAPIE 4: INTEGRACJA Z BAZƒÑ DANYCH SQLite
- Automatyczne zapisywanie tras do bazy danych
- Migracja danych pogodowych do bazy danych
- Fallback na pliki JSON w przypadku problem√≥w z bazƒÖ

FUNKCJONALNO≈öƒÜ:
- Pobiera dane o szlakach turystycznych dla wszystkich region√≥w ‚Üí BAZA DANYCH
- Pobiera prognozy pogody na najbli≈ºsze 7 dni dla wszystkich miast ‚Üí BAZA DANYCH  
- Zapisuje dane do bazy SQLite (g≈Ç√≥wnie) i plik√≥w JSON (fallback)
- Obs≈Çuguje b≈Çƒôdy pobierania dla poszczeg√≥lnych region√≥w/dat
- Inicjalizuje puste pliki je≈õli nie istniejƒÖ

AKTUALIZOWANE DANE:
1. routes (tabela bazy danych) - dane o szlakach turystycznych
2. weather_data (tabela bazy danych) - prognozy pogody na 7 dni
3. trails_data.json (fallback) - dane o szlakach
4. weather_dataa.json (fallback) - prognozy pogody

U≈ªYCIE:
python api/update_data.py

WYMAGANIA:
- Dzia≈ÇajƒÖce po≈ÇƒÖczenie internetowe
- Dostƒôp do Overpass API i Open-Meteo API
- Uprawnienia do zapisu w katalogu g≈Ç√≥wnym projektu
- Baza danych SQLite (data/database/routes.db)

AUTOR: System Rekomendacji Tras Turystycznych - Etap 4
"""

# ============================================================================
# KONFIGURACJA ≈öCIE≈ªEK I IMPORT√ìW
# ============================================================================

# Dodanie katalogu g≈Ç√≥wnego projektu do ≈õcie≈ºki Python
# Umo≈ºliwia import modu≈Ç√≥w z katalogu nadrzƒôdnego
import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# ============================================================================
# IMPORTY MODU≈Å√ìW PROJEKTU
# ============================================================================

from api.trails_api import TrailsAPI         # Klasa do pobierania danych o szlakach (z bazƒÖ danych!)
from api.weather_api import WeatherAPI       # Klasa do pobierania danych pogodowych
from config import CITY_COORDINATES         # S≈Çownik miast i ich wsp√≥≈Çrzƒôdnych
import json                                 # Obs≈Çuga formatu JSON
from datetime import datetime, timedelta    # Operacje na datach

# ============================================================================
# IMPORTY BAZY DANYCH
# ============================================================================
try:
    from database import DatabaseManager
    from database.repositories.weather_repository import WeatherRepository
    DATABASE_AVAILABLE = True
except ImportError:
    print("‚ö†Ô∏è Baza danych niedostƒôpna. U≈ºywam tylko plik√≥w JSON.")
    DATABASE_AVAILABLE = False

# ============================================================================
# FUNKCJA AKTUALIZACJI DANYCH O SZLAKACH
# ============================================================================

def update_trails_data():
    """
    Pobiera i aktualizuje dane o szlakach turystycznych dla wszystkich region√≥w.
    
    NOWE W ETAPIE 4: Automatyczne zapisywanie do bazy danych SQLite
    
    Funkcja iteruje przez wszystkie miasta zdefiniowane w CITY_COORDINATES,
    pobiera dla ka≈ºdego z nich dane o szlakach u≈ºywajƒÖc TrailsAPI (kt√≥re teraz
    automatycznie zapisuje do bazy danych), a nastƒôpnie zapisuje zagregowane 
    dane do pliku trails_data.json jako fallback.
    
    Proces:
    1. Inicjalizacja API z obs≈ÇugƒÖ bazy danych
    2. Iteracja przez wszystkie regiony z CITY_COORDINATES
    3. Pobieranie szlak√≥w dla ka≈ºdego regionu ‚Üí AUTOMATYCZNY ZAPIS DO BAZY
    4. Agregacja wszystkich szlak√≥w w jednƒÖ listƒô
    5. Zapis do pliku trails_data.json (fallback/backup)
    
    Obs≈Çuga b≈Çƒôd√≥w:
    - B≈Çƒôdy pobierania dla poszczeg√≥lnych region√≥w nie przerywajƒÖ procesu
    - Wszystkie b≈Çƒôdy sƒÖ logowane z informacjƒÖ o regionie
    - Proces kontynuuje dla pozosta≈Çych region√≥w
    - Baza danych ma automatyczny fallback na pliki JSON
    
    Returns:
        None: Funkcja zapisuje dane do bazy i pliku, nie zwraca warto≈õci
    """
    # Inicjalizacja API do pobierania danych o szlakach (teraz z bazƒÖ danych!)
    api = TrailsAPI()
    
    # Lista na wszystkie szlaki ze wszystkich region√≥w (dla fallback JSON)
    all_trails = []

    print("=== üèîÔ∏è AKTUALIZACJA DANYCH O SZLAKACH TURYSTYCZNYCH ===")
    print("Pobieranie danych o szlakach dla wszystkich region√≥w...")
    print("üíæ Trasy bƒôdƒÖ automatycznie zapisane do bazy danych SQLite")
    
    # ========================================================================
    # ITERACJA PRZEZ WSZYSTKIE REGIONY
    # ========================================================================
    
    # Pobieranie szlak√≥w dla ka≈ºdego miasta z konfiguracji
    for region in CITY_COORDINATES.keys():
        print(f"\nüó∫Ô∏è Pobieranie szlak√≥w dla regionu: {region}")
        
        try:
            # Pr√≥ba pobrania szlak√≥w dla danego regionu
            # UWAGA: TrailsAPI teraz automatycznie zapisuje do bazy danych!
            trails = api.get_hiking_trails(region)
            
            # Sprawdzenie czy pobrano jakie≈õ dane
            if trails:
                # Dodanie pobranych szlak√≥w do g≈Ç√≥wnej listy (dla fallback JSON)
                all_trails.extend(trails)
                print(f"‚úÖ Znaleziono {len(trails)} szlak√≥w dla {region}")
            else:
                print(f"‚ö†Ô∏è Brak szlak√≥w dla regionu {region}")
                
        except Exception as e:
            # Obs≈Çuga b≈Çƒôd√≥w - logowanie i kontynuacja
            print(f"‚ùå B≈ÇƒÖd podczas pobierania szlak√≥w dla {region}: {e}")

    # ========================================================================
    # PODSUMOWANIE I ZAPIS DANYCH O SZLAKACH (FALLBACK JSON)
    # ========================================================================
    
    print(f"\nüìä PODSUMOWANIE AKTUALIZACJI TRAS:")
    print(f"   üéØ ≈ÅƒÖcznie przetworzono {len(all_trails)} szlak√≥w")
    print(f"   üíæ Trasy zosta≈Çy zapisane do bazy danych SQLite")
    print(f"   üìÅ Tworzenie pliku JSON jako backup...")

    # Inicjalizacja pustego pliku je≈õli nie istnieje
    if not os.path.exists('trails_data.json'):
        with open('trails_data.json', 'w', encoding='utf-8') as f:
            json.dump([], f)
        print("üìÑ Utworzono pusty plik trails_data.json")

    # Zapis wszystkich danych o szlakach do pliku JSON (backup)
    try:
        with open('trails_data.json', 'w', encoding='utf-8') as f:
            json.dump(all_trails, f, ensure_ascii=False, indent=2)
        print(f"‚úÖ Backup danych zapisany do pliku trails_data.json ({len(all_trails)} tras)")
        
    except Exception as e:
        print(f"‚ùå B≈ÇƒÖd podczas zapisywania backup danych o szlakach: {e}")

# ============================================================================
# FUNKCJA AKTUALIZACJI DANYCH POGODOWYCH
# ============================================================================

def update_weather_data():
    """
    Pobiera i aktualizuje prognozy pogody dla wszystkich region√≥w na najbli≈ºsze 7 dni.
    
    NOWE W ETAPIE 4: Zapisywanie do bazy danych SQLite
    
    Funkcja iteruje przez wszystkie miasta zdefiniowane w CITY_COORDINATES,
    pobiera dla ka≈ºdego z nich prognozy pogody na nastƒôpne 7 dni u≈ºywajƒÖc WeatherAPI,
    a nastƒôpnie zapisuje dane do bazy danych i pliku weather_dataa.json.
    
    Proces:
    1. Inicjalizacja API i bazy danych
    2. Iteracja przez wszystkie regiony z CITY_COORDINATES
    3. Dla ka≈ºdego regionu pobieranie prognoz na 7 dni (z obs≈ÇugƒÖ b≈Çƒôd√≥w)
    4. Zapis do bazy danych SQLite
    5. Zapis do pliku weather_dataa.json (fallback)
    
    Zakres dat:
    - Pobiera prognozy od dzisiaj do 6 dni w przysz≈Ço≈õƒá (≈ÇƒÖcznie 7 dni)
    - Ka≈ºda prognoza zawiera datƒô, region i parametry pogodowe
    
    Obs≈Çuga b≈Çƒôd√≥w:
    - B≈Çƒôdy pobierania dla poszczeg√≥lnych region√≥w/dat nie przerywajƒÖ procesu
    - Wszystkie b≈Çƒôdy sƒÖ logowane z informacjƒÖ o regionie
    - Proces kontynuuje dla pozosta≈Çych region√≥w i dat
    
    Returns:
        None: Funkcja zapisuje dane do bazy i pliku, nie zwraca warto≈õci
    """
    # Inicjalizacja API do pobierania danych pogodowych
    api = WeatherAPI()
    
    # ========================================================================
    # NOWE: INICJALIZACJA BAZY DANYCH DLA POGODY
    # ========================================================================
    weather_repo = None
    if DATABASE_AVAILABLE:
        try:
            db_manager = DatabaseManager()
            db_manager.initialize_database()
            weather_repo = WeatherRepository(db_manager)
            print("‚úÖ WeatherRepository po≈ÇƒÖczony z bazƒÖ danych SQLite")
        except Exception as e:
            print(f"‚ö†Ô∏è B≈ÇƒÖd po≈ÇƒÖczenia z bazƒÖ danych pogody: {e}")
    
    # Lista na wszystkie prognozy pogody ze wszystkich region√≥w
    all_weather = []

    print("\n=== üå§Ô∏è AKTUALIZACJA DANYCH POGODOWYCH ===")
    print("Pobieranie danych pogodowych dla wszystkich region√≥w...")
    if weather_repo:
        print("üíæ Dane pogodowe bƒôdƒÖ zapisane do bazy danych SQLite")
    
    # ========================================================================
    # ITERACJA PRZEZ WSZYSTKIE REGIONY I DATY
    # ========================================================================
    
    # Pobieranie prognoz pogody dla ka≈ºdego miasta z konfiguracji
    for region in CITY_COORDINATES.keys():
        print(f"\nüåç Pobieranie prognozy pogody dla regionu: {region}")
        
        try:
            # Pobieranie prognoz na najbli≈ºsze 7 dni (0-6 dni od dzisiaj)
            for i in range(7):  # Get forecast for next 7 days
                # Obliczenie daty (dzisiaj + i dni)
                date = (datetime.now() + timedelta(days=i)).strftime("%Y-%m-%d")
                
                # Pr√≥ba pobrania prognozy dla danej daty
                weather = api.get_weather_forecast(region, date)
                
                # Sprawdzenie czy pobrano dane pogodowe
                if weather:
                    # Dodanie prognozy do g≈Ç√≥wnej listy
                    all_weather.append(weather)
                    
                    # NOWE: Zapis do bazy danych
                    if weather_repo:
                        try:
                            weather_data = _convert_weather_to_database_format(weather, region)
                            weather_repo.add_weather_data(weather_data)
                            print(f"üíæ Zapisano prognozƒô dla {region} na {date} do bazy danych")
                        except Exception as e:
                            print(f"‚ö†Ô∏è B≈ÇƒÖd zapisu do bazy: {e}")
                    else:
                        print(f"üìÑ Pobrano prognozƒô dla {region} na {date}")
                else:
                    print(f"‚ö†Ô∏è Brak prognozy dla {region} na {date}")
                    
        except Exception as e:
            # Obs≈Çuga b≈Çƒôd√≥w - logowanie i kontynuacja
            print(f"‚ùå B≈ÇƒÖd podczas pobierania prognozy pogody dla {region}: {e}")

    # ========================================================================
    # PODSUMOWANIE I ZAPIS DANYCH POGODOWYCH (FALLBACK JSON)
    # ========================================================================
    
    print(f"\nüìä PODSUMOWANIE AKTUALIZACJI POGODY:")
    print(f"   üéØ ≈ÅƒÖcznie pobrano {len(all_weather)} prognoz pogody")
    if weather_repo:
        print(f"   üíæ Dane zosta≈Çy zapisane do bazy danych SQLite")
    print(f"   üìÅ Tworzenie pliku JSON jako backup...")

    # Inicjalizacja pustego pliku je≈õli nie istnieje
    if not os.path.exists('weather_dataa.json'):
        with open('weather_dataa.json', 'w', encoding='utf-8') as f:
            json.dump([], f)
        print("üìÑ Utworzono pusty plik weather_dataa.json")

    # Zapis wszystkich danych pogodowych do pliku JSON (backup)
    try:
        with open('weather_dataa.json', 'w', encoding='utf-8') as f:
            json.dump(all_weather, f, ensure_ascii=False, indent=2)
        print(f"‚úÖ Backup danych pogodowych zapisany do pliku weather_dataa.json ({len(all_weather)} rekord√≥w)")
        
    except Exception as e:
        print(f"‚ùå B≈ÇƒÖd podczas zapisywania backup danych pogodowych: {e}")

# ============================================================================
# FUNKCJE POMOCNICZE
# ============================================================================

def _convert_weather_to_database_format(weather: dict, region: str) -> dict:
    """
    Konwertuje dane pogodowe z API na format bazy danych.
    
    Args:
        weather: Dane pogodowe z API
        region: Nazwa regionu
        
    Returns:
        Dane pogodowe w formacie bazy danych
    """
    # Pobierz wsp√≥≈Çrzƒôdne miasta z konfiguracji
    coordinates = CITY_COORDINATES.get(region, {"lat": 50.0, "lon": 20.0})
    
    return {
        'date': weather.get('date'),
        'location_lat': coordinates['lat'],
        'location_lon': coordinates['lon'],
        'avg_temp': weather.get('temperature_2m_mean'),
        'min_temp': weather.get('temperature_2m_min'),
        'max_temp': weather.get('temperature_2m_max'),
        'precipitation': weather.get('precipitation_sum'),
        'sunshine_hours': weather.get('sunshine_duration', 0) / 3600,  # Konwersja sekund na godziny
        'cloud_cover': weather.get('cloud_cover_mean'),
        'wind_speed': weather.get('wind_speed_10m_max'),
        'humidity': weather.get('relative_humidity_2m_mean')
    }

# ============================================================================
# PUNKT WEJ≈öCIA SKRYPTU
# ============================================================================

if __name__ == "__main__":
    """
    Punkt wej≈õcia skryptu - wykonuje kompleksowƒÖ aktualizacjƒô danych.
    
    Sprawdza czy skrypt jest uruchamiany jako g≈Ç√≥wny program (nie importowany)
    i je≈õli tak, wywo≈Çuje obie funkcje aktualizacji:
    1. update_trails_data() - aktualizacja danych o szlakach ‚Üí BAZA DANYCH
    2. update_weather_data() - aktualizacja prognoz pogody ‚Üí BAZA DANYCH
    
    Kolejno≈õƒá wykonania jest wa≈ºna - najpierw szlaki, potem pogoda.
    """
    print("=" * 80)
    print("üèîÔ∏è SYSTEM REKOMENDACJI TRAS TURYSTYCZNYCH - ETAP 4")
    print("üíæ KOMPLEKSOWA AKTUALIZACJA DANYCH Z BAZƒÑ DANYCH SQLite")
    print("=" * 80)
    
    print("\nüöÄ ROZPOCZƒòCIE KOMPLEKSOWEJ AKTUALIZACJI DANYCH")
    print("1Ô∏è‚É£ Aktualizacja danych o szlakach turystycznych")
    update_trails_data()
    
    print("\n" + "="*60)
    print("2Ô∏è‚É£ Aktualizacja prognoz pogody")
    update_weather_data()
    
    print("\n" + "="*80)
    print("üéâ ZAKO≈ÉCZENIE AKTUALIZACJI DANYCH")
    print("‚úÖ Wszystkie dane zosta≈Çy zaktualizowane w bazie danych SQLite!")
    print("üìÅ Pliki JSON utworzone jako backup")
    print("üéØ System gotowy do u≈ºycia z bazƒÖ danych!")
    print("=" * 80) 